<!DOCTYPE html>
<html>

<head>
  <title>Chat</title>
  <style>
    body {
      font: 14px sans-serif;
      max-width: 400px;
      margin: 40px auto;
    }

    #log {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 8px;
      margin-bottom: 8px;
    }

    input {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
    }
  </style>
</head>

<body>
  <chat-app></chat-app>
  <script src="https://unpkg.com/hyper-element"></script>
  <script src="/api/ape.js"></script>
  <script>
    document.registerElement('chat-app', class extends HyperElement {
      created() {
        this.user = 'User' + Math.random().toString(36).slice(2, 6)
        this.messages = []
        ape.history().then(msgs => { this.messages = msgs; this.render() })
        ape.on('message', m => { this.messages.push(m); this.render() })
      }

      send(e) {
        if (e.key !== 'Enter' || !e.target.value) return
        ape.message({ user: this.user, text: e.target.value })
          .then(m => { this.messages.push(m); this.render() })
        e.target.value = ''
      }

      render(Html) {
        Html`
          <div id="log">
            ${this.messages.map(m => Html`<div><b>${m.user}:</b> ${m.text}</div>`)}
          </div>
          <input placeholder="Type message, press Enter" onkeydown=${e => this.send(e)} autofocus>
        `
      }
    })
  </script>
</body>

</html>