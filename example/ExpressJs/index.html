<!DOCTYPE html>
<html>

<head>
  <title>Chat</title>
  <style>
    body {
      font: 14px sans-serif;
      max-width: 400px;
      margin: 40px auto;
    }

    #log {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 8px;
      margin-bottom: 8px;
    }

    input {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
    }
  </style>
</head>

<body>
  <chat-app></chat-app>
  <script src="https://unpkg.com/hyperhtml"></script>
  <script src="https://unpkg.com/hyper-element"></script>
  <script src="/api/ape.js"></script>
  <script>
    customElements.define('chat-app', class extends hyperElement {
      setup(attachStore) {
        this.user = 'User' + Math.random().toString(36).slice(2, 6)
        this.messages = []

        this.onStoreChange = attachStore(() => this.messages)

        // Load history
        ape.history().then(msgs => {
          this.messages = msgs
          this.onStoreChange()
        })

        // Listen for new messages from others
        ape.on('message', ({ data }) => {
          this.messages.push(data)
          this.onStoreChange()
        })
      }

      send(e) {
        if (e.key !== 'Enter' || !e.target.value) return
        const msg = { user: this.user, text: e.target.value }
        ape.message(msg).then(() => {
          this.messages.push(msg)
          this.onStoreChange()
        })
        e.target.value = ''
      }

      render(Html, messages) {
        messages = messages || []
        Html`
          <div id="log">
            ${messages.map(m => Html.wire(m, ':msg')`<div><b>${m.user}:</b> ${m.text}</div>`)}
          </div>
          <input placeholder="Type message, press Enter" onkeydown=${e => this.send(e)} autofocus>
        `
      }
    })
  </script>
</body>

</html>