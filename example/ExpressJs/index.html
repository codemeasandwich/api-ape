<!DOCTYPE html>
<html>

<head>
  <title>Chat - api-ape</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/styles.css">
</head>

<body>
  <chat-app></chat-app>
  <script src="https://unpkg.com/hyperhtml"></script>
  <script src="https://unpkg.com/hyper-element"></script>
  <script src="/api/ape.js"></script>
  <script>
    customElements.define('chat-app', class extends hyperElement {
      setup(attachStore) {
        this.user = 'User' + Math.random().toString(36).slice(2, 6)
        this.messages = []

        this.onStoreChange = attachStore(() => this.messages)

        // Load history
        ape.history().then(msgs => {
          this.messages = msgs
          this.onStoreChange()
        })

        // Listen for new messages from others
        ape.on('message', ({ data }) => {
          this.messages.push(data)
          this.onStoreChange()
        })
      }

      send(e) {
        if (e.key !== 'Enter' || !e.target.value) return
        const msg = { user: this.user, text: e.target.value }
        ape.message(msg).then(() => {
          this.messages.push(msg)
          this.onStoreChange()
        })
        e.target.value = ''
      }

      render(Html, messages) {
        messages = messages || []
        Html`
          <div class="chat-container">
            <div class="header">
              <span class="title">ğŸ’¬ Chat</span>
              <span class="user-badge">â— ${this.user}</span>
            </div>
            <div class="messages">
              ${messages.length === 0
            ? Html.wire()`<div class="empty-state">No messages yet...</div>`
            : messages.map(m => Html.wire(m, ':msg')`
                    <div class="${'message' + (m.user === this.user ? ' mine' : '')}">
                      <span class="username">${m.user}</span>
                      <span class="text">${m.text}</span>
                    </div>
                  `)
          }
            </div>
            <div class="input-area">
              <input 
                class="message-input" 
                placeholder="Type a message..." 
                onkeydown=${e => this.send(e)} 
                autofocus
              >
            </div>
          </div>
        `
      }
    })
  </script>
</body>

</html>